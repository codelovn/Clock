<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="BaoHy Personal Dashboard - Titan Edition">
    <meta name="author" content="B·∫£o Hy">
    <meta name="theme-color" content="#050836">
    <title>BaoHy OS ‚Ä¢ Titan Edition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@100;200;300;400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ==========================================================================
           1. CORE VARIABLES & RESET (SYSTEM CONFIG)
           ========================================================================== */
        :root {
            /* Color Palette - Deep Space Theme */
            --color-bg-dark: #02041a;
            --color-bg-main: #050836;
            --color-primary: #0048ba;
            --color-accent: #00bfff;
            --color-highlight: #e0f7fa;
            --color-danger: #ff4757;
            --color-success: #2ed573;
            --color-warning: #ffa502;
            
            /* Glassmorphism System */
            --glass-1: rgba(255, 255, 255, 0.05);
            --glass-2: rgba(255, 255, 255, 0.1);
            --glass-3: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shine: rgba(255, 255, 255, 0.25);
            --shadow-deep: 0 20px 50px rgba(0,0,0,0.5);
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            
            /* Typography */
            --font-main: 'Be Vietnam Pro', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            
            /* Transitions */
            --trans-fast: 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --trans-smooth: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* Standard Reset */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--glass-3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-accent); }
        
        body {
            background-color: var(--color-bg-dark);
            color: #ffffff;
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; /* Prevent text selection for App-feel */
        }

        /* ==========================================================================
           2. BACKGROUND & CANVAS ENGINE
           ========================================================================== */
        #universe-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 120%, #1a237e, #050836 60%, #000000);
            z-index: 1;
        }
        
        #weather-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none;
        }

        #noise-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.03; z-index: 3; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }

        /* ==========================================================================
           3. MAIN LAYOUT (GRID SYSTEM)
           ========================================================================== */
        .os-container {
            position: relative; z-index: 10;
            width: 96%; height: 94%;
            max-width: 1800px;
            background: rgba(5, 8, 54, 0.45);
            backdrop-filter: blur(25px) saturate(120%);
            -webkit-backdrop-filter: blur(25px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            box-shadow: var(--shadow-deep);
            padding: 24px;
            display: grid;
            grid-template-columns: 320px 1fr 380px; /* 3 C·ªôt chu·∫©n */
            grid-template-rows: 80px 1fr 60px; /* Header - Main - Footer */
            gap: 20px;
            transition: var(--trans-smooth);
            animation: bootUp 1.2s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* --- AREAS DEFINITION --- */
        .area-header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .area-sidebar { grid-row: 2 / 3; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-right: 5px; }
        .area-main { grid-row: 2 / 3; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .area-news { grid-row: 2 / 3; display: flex; flex-direction: column; gap: 20px; background: rgba(0,0,0,0.2); border-radius: 24px; padding: 20px; border: 1px solid var(--glass-border); }
        .area-footer { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--glass-border); padding-top: 10px; font-size: 0.8rem; color: var(--glass-shine); }

        /* ==========================================================================
           4. COMPONENT STYLES
           ========================================================================== */
        /* Glass Card */
        .glass-card {
            background: var(--glass-1);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            transition: var(--trans-fast);
            position: relative;
            overflow: hidden;
        }
        .glass-card:hover { background: var(--glass-2); transform: translateY(-3px); box-shadow: var(--shadow-glass); border-color: var(--glass-shine); }
        
        .card-header { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px; 
            color: var(--color-accent); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; 
        }

        /* Buttons */
        .btn-icon {
            width: 45px; height: 45px; border-radius: 14px; border: none;
            background: var(--glass-2); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: var(--trans-fast);
        }
        .btn-icon:hover { background: var(--color-primary); transform: scale(1.05); }
        .btn-icon:active { transform: scale(0.95); }

        .btn-action {
            padding: 10px 20px; border-radius: 12px; border: none; cursor: pointer;
            font-weight: 600; font-family: var(--font-main); transition: var(--trans-fast);
            display: flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--color-accent); color: var(--color-bg-main); box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3); }
        .btn-primary:hover { filter: brightness(1.1); box-shadow: 0 6px 20px rgba(0, 191, 255, 0.5); }

        /* Clock Typography */
        .clock-huge {
            font-size: 8.5rem; font-weight: 200; line-height: 0.9; letter-spacing: -4px;
            background: linear-gradient(180deg, #ffffff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 40px rgba(0, 72, 186, 0.4));
            font-variant-numeric: tabular-nums;
        }
        .date-badge {
            margin-top: 20px; padding: 10px 25px; border-radius: 50px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            font-weight: 300; font-size: 1.1rem; color: var(--color-highlight);
            display: flex; gap: 10px; align-items: center;
        }

        /* Weather Hero */
        .weather-display-lg {
            display: flex; align-items: center; gap: 20px; margin-top: 40px;
            padding: 30px; border-radius: 30px;
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
            border: 1px solid var(--glass-border);
            animation: float 6s ease-in-out infinite;
        }
        .weather-icon-lg { font-size: 5rem; filter: drop-shadow(0 0 20px rgba(255,255,255,0.4)); }
        .weather-temp-lg { font-size: 4rem; font-weight: 200; }
        .weather-desc-lg { font-size: 1rem; opacity: 0.8; text-transform: capitalize; }

        /* Smart Alert */
        .smart-alert-box {
            margin-top: 30px; width: 100%; max-width: 600px;
            background: rgba(0, 191, 255, 0.1); border-left: 4px solid var(--color-accent);
            padding: 15px 20px; border-radius: 0 16px 16px 0;
            display: flex; align-items: flex-start; gap: 15px;
            backdrop-filter: blur(10px);
        }

        /* News List */
        .news-item {
            padding: 12px 0; border-bottom: 1px solid var(--glass-1);
            cursor: pointer; transition: 0.2s;
        }
        .news-item:hover { padding-left: 10px; background: var(--glass-1); border-radius: 8px; }
        .news-time { font-size: 0.7rem; color: var(--color-accent); display: block; margin-bottom: 4px; font-family: var(--font-code); }
        .news-title { font-size: 0.9rem; line-height: 1.4; color: #eee; }

        /* Tools Grid */
        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .tool-tile {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            padding: 20px; background: var(--glass-1); border-radius: 16px;
            border: 1px solid transparent; cursor: pointer; transition: 0.3s;
        }
        .tool-tile:hover { background: var(--color-primary); border-color: var(--glass-shine); box-shadow: 0 10px 30px rgba(0, 72, 186, 0.4); }
        .tool-tile i { font-size: 1.8rem; color: var(--color-accent); transition: 0.3s; }
        .tool-tile:hover i { color: white; transform: scale(1.2); }
        .tool-tile span { font-size: 0.85rem; font-weight: 500; }

        /* Task Manager Styling */
        .task-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .task-input { flex: 1; background: var(--glass-1); border: 1px solid var(--glass-border); padding: 8px 12px; border-radius: 8px; color: white; }
        .task-list { max-height: 150px; overflow-y: auto; }
        .task-row { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid var(--glass-1); animation: slideIn 0.3s ease; }
        .task-row.done span { text-decoration: line-through; opacity: 0.5; }
        .task-check { accent-color: var(--color-accent); width: 18px; height: 18px; }

        /* ==========================================================================
           5. RESPONSIVE MEDIA QUERIES
           ========================================================================== */
        @media (max-width: 1200px) {
            .os-container { grid-template-columns: 1fr 1fr; grid-template-rows: auto auto 1fr auto; padding: 15px; }
            .area-sidebar { grid-column: 1 / 2; grid-row: 2 / 3; }
            .area-news { grid-column: 2 / 3; grid-row: 2 / 3; }
            .area-main { grid-column: 1 / -1; grid-row: 3 / 4; margin-top: 20px; }
            .clock-huge { font-size: 6rem; }
        }

        @media (max-width: 768px) {
            .os-container { display: flex; flex-direction: column; height: 100vh; width: 100%; border-radius: 0; border: none; overflow-y: auto; }
            .area-header, .area-footer { flex-shrink: 0; }
            .area-main { order: 1; margin-bottom: 30px; }
            .area-sidebar { order: 2; margin-bottom: 20px; height: auto; overflow: visible; }
            .area-news { order: 3; height: auto; min-height: 300px; }
            .clock-huge { font-size: 4.5rem; }
            .weather-display-lg { width: 100%; flex-direction: column; text-align: center; }
            .tools-grid { grid-template-columns: repeat(4, 1fr); }
            .tool-tile { padding: 15px; }
            .tool-tile span { display: none; } /* Hide text on mobile */
        }

        /* Animations */
        @keyframes bootUp { 0% { opacity: 0; transform: scale(0.98); filter: blur(10px); } 100% { opacity: 1; transform: scale(1); filter: blur(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    </style>
</head>
<body>

    <div id="universe-layer"></div>
    <canvas id="weather-canvas"></canvas>
    <div id="noise-overlay"></div>

    <main class="os-container" id="app-root">
        
        <header class="area-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 40px; height: 40px; background: var(--color-primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: var(--font-code);">BH</div>
                <div>
                    <h3 style="font-size: 1rem; font-weight: 600;">BaoHy OS</h3>
                    <span style="font-size: 0.75rem; opacity: 0.7;" id="system-status">System Normal ‚Ä¢ GPU Active</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-icon" onclick="App.toggleFullScreen()" title="Full Screen"><i class="fas fa-expand"></i></button>
                <button class="btn-icon" onclick="App.reloadWeather()" title="Refresh Data"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>

        <aside class="area-sidebar">
            
            <div class="glass-card">
                <div class="card-header"><i class="fas fa-th-large"></i> Quick Access</div>
                <div class="tools-grid">
                    <div class="tool-tile" onclick="App.openLink('https://calendar.google.com')">
                        <i class="fas fa-calendar-alt"></i><span>L·ªãch</span>
                    </div>
                    <div class="tool-tile" onclick="App.openLink('https://chat.openai.com')">
                        <i class="fas fa-brain"></i><span>AI Chat</span>
                    </div>
                    <div class="tool-tile" onclick="App.openLink('https://youtube.com')">
                        <i class="fab fa-youtube"></i><span>YouTube</span>
                    </div>
                    <div class="tool-tile" onclick="Widgets.Calculator.toggle()">
                        <i class="fas fa-calculator"></i><span>M√°y T√≠nh</span>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header"><i class="fas fa-stopwatch"></i> Focus Mode</div>
                <div style="text-align: center;">
                    <div id="pomo-timer" style="font-size: 3rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--color-accent);">25:00</div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                        <button class="btn-action btn-primary" id="pomo-btn-main" onclick="Widgets.Pomodoro.toggle()">B·∫Øt ƒë·∫ßu</button>
                        <button class="btn-icon" onclick="Widgets.Pomodoro.reset()"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
            </div>

            <div class="glass-card" style="flex: 1;">
                <div class="card-header"><i class="fas fa-tasks"></i> Nhi·ªám v·ª•</div>
                <div class="task-input-group">
                    <input type="text" class="task-input" id="task-in" placeholder="Th√™m vi·ªác m·ªõi..." onkeypress="Widgets.Tasks.handleEnter(event)">
                    <button class="btn-icon" style="width: 35px; height: 35px; border-radius: 8px;" onclick="Widgets.Tasks.add()"><i class="fas fa-plus"></i></button>
                </div>
                <div class="task-list" id="task-list-ui">
                    </div>
            </div>

        </aside>

        <section class="area-main">
            <div class="clock-huge" id="clock-display">00:00:00</div>
            
            <div class="date-badge">
                <i class="far fa-calendar"></i>
                <span id="date-solar">ƒêang t·∫£i...</span>
                <span style="opacity: 0.5;">|</span>
                <span id="date-lunar" style="color: var(--color-warning);">√Çm l·ªãch...</span>
            </div>

            <div class="weather-display-lg">
                <i class="fas fa-meteor weather-icon-lg" id="weather-icon-main"></i>
                <div style="text-align: left;">
                    <div class="weather-temp-lg" id="weather-temp">--¬∞</div>
                    <div class="weather-desc-lg" id="weather-desc">ƒêang k·∫øt n·ªëi v·ªá tinh...</div>
                    <div style="margin-top: 10px; font-size: 0.9rem; display: flex; gap: 15px; opacity: 0.9;">
                        <span><i class="fas fa-wind"></i> <span id="w-wind">--</span> km/h</span>
                        <span><i class="fas fa-tint"></i> <span id="w-humid">--</span>%</span>
                        <span><i class="fas fa-sun"></i> UV: <span id="w-uv">--</span></span>
                    </div>
                </div>
            </div>

            <div class="smart-alert-box" id="smart-alert">
                <i class="fas fa-robot" style="font-size: 1.5rem; color: var(--color-accent);"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 3px;">Tr·ª£ l√Ω ·∫£o B·∫£o Hy</div>
                    <div style="font-size: 0.95rem; line-height: 1.4;" id="alert-msg">Kh·ªüi ƒë·ªông h·ªá th·ªëng...</div>
                </div>
            </div>
        </section>

        <aside class="area-news">
            <div class="card-header">
                <i class="fas fa-globe-asia"></i> Tin T·ª©c Tr·ª±c Tuy·∫øn
                <div style="margin-left: auto; display: flex; gap: 5px;">
                    <div style="width: 8px; height: 8px; background: var(--color-success); border-radius: 50%; animate: pulse 1s infinite;"></div>
                    <span style="font-size: 0.6rem;">LIVE</span>
                </div>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding-right: 5px;" id="news-feed">
                <div class="news-item"><span class="news-title">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ VnExpress...</span></div>
            </div>

            <div style="padding-top: 20px; border-top: 1px solid var(--glass-border);">
                <div style="font-size: 0.75rem; color: var(--glass-shine); margin-bottom: 10px;">MOON PHASE</div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-moon" id="moon-icon" style="color: #f1c40f;"></i>
                        <span id="moon-text">--</span>
                    </div>
                    <span style="font-size: 0.8rem;" id="moon-age">Age: --</span>
                </div>
            </div>
        </aside>

        <footer class="area-footer">
            <div>
                <i class="fas fa-wifi"></i> Connected &bull; 
                <span id="geo-loc">ƒê·ªãnh v·ªã...</span>
            </div>
            <div style="font-family: var(--font-code);">
                Designed by <span style="color: var(--color-accent); font-weight: bold;">@baohyne</span> ‚Ä¢ v3.0 Ultimate
            </div>
        </footer>

    </main>

    <script>
        /**
         * BAOHY OS - TITAN EDITION
         * Core Architecture:
         * 1. TimeEngine: Manages Solar/Lunar Time.
         * 2. WeatherStation: Advanced Open-Meteo Integration with UV logic.
         * 3. NewsRoom: RSS Parser & Caching.
         * 4. VisualCore: Canvas Particle System (Rain, Stars).
         * 5. WidgetManager: Tasks, Pomodoro, etc.
         */

        // --- GLOBAL CONFIG ---
        const CONFIG = {
            user: "B·∫£o Hy",
            location: { lat: 10.80, lon: 105.15, name: "T√¢n Ch√¢u, An Giang" }, // Default fallback
            api: {
                weather: "https://api.open-meteo.com/v1/forecast",
                rss: "https://api.rss2json.com/v1/api.json?rss_url=https://vnexpress.net/rss/tin-moi-nhat.rss"
            },
            refreshRate: {
                weather: 1800000, // 30 mins
                news: 900000,     // 15 mins
                clock: 1000       // 1 sec
            }
        };

        // --- UTILS CLASS ---
        class Utils {
            static pad(num) { return num.toString().padStart(2, '0'); }
            
            static capitalize(str) { 
                return str.charAt(0).toUpperCase() + str.slice(1); 
            }
            
            static getGreeting() {
                const h = new Date().getHours();
                if (h < 5) return "ƒê√™m khuya r·ªìi";
                if (h < 11) return "Ch√†o bu·ªïi s√°ng";
                if (h < 14) return "Bu·ªïi tr∆∞a vui v·∫ª";
                if (h < 18) return "Chi·ªÅu m√°t m·∫ª";
                return "Bu·ªïi t·ªëi an l√†nh";
            }

            // Simple storage wrapper
            static save(key, data) { localStorage.setItem(`baohy_${key}`, JSON.stringify(data)); }
            static load(key) { return JSON.parse(localStorage.getItem(`baohy_${key}`)); }
        }

        // --- TIME ENGINE (SOLAR & LUNAR) ---
        class TimeEngine {
            constructor() {
                this.init();
            }

            init() {
                this.update();
                setInterval(() => this.update(), 1000);
            }

            update() {
                const now = new Date();
                
                // 1. Digital Clock
                document.getElementById('clock-display').innerText = 
                    `${Utils.pad(now.getHours())}:${Utils.pad(now.getMinutes())}:${Utils.pad(now.getSeconds())}`;

                // 2. Solar Date
                const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                document.getElementById('date-solar').innerText = Utils.capitalize(now.toLocaleDateString('vi-VN', options));

                // 3. Lunar Date (Approximate Algorithm for display)
                // Note: A full astronomical Lunar algorithm is 2000+ lines itself. 
                // Using a simplified logic based on Moon Phase age for demonstration.
                const lunar = this.getApproxLunar(now);
                document.getElementById('date-lunar').innerText = `${lunar.day}/${lunar.month} √Çm L·ªãch`;
            }

            getApproxLunar(date) {
                // Simplified calculation relative to a known lunar anchor
                // This is for display purposes in this snippet context
                const knownLunar = new Date(2023, 0, 22); // Tet 2023
                const diffTime = Math.abs(date - knownLunar);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                // Rough cycle of 29.53 days
                let lunarDay = (diffDays % 29) + 1;
                // Rough month estimation (not accurate for leap months but functional for UI demo)
                let lunarMonth = (Math.floor(diffDays / 29) % 12) + 1;
                return { day: Utils.pad(lunarDay), month: Utils.pad(lunarMonth) };
            }
        }

        // --- VISUAL CORE (CANVAS PHYSICS) ---
        class VisualCore {
            constructor() {
                this.canvas = document.getElementById('weather-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.w = window.innerWidth;
                this.h = window.innerHeight;
                this.mode = 'clear'; // clear, rain, stars
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.loop();
            }

            resize() {
                this.w = this.canvas.width = window.innerWidth;
                this.h = this.canvas.height = window.innerHeight;
            }

            setMode(weatherCode, isDay) {
                this.particles = [];
                // Reset mode
                if (weatherCode >= 50 && weatherCode <= 99) {
                    this.mode = 'rain';
                    this.initRain(150);
                } else if (!isDay) {
                    this.mode = 'stars';
                    this.initStars(100);
                } else {
                    this.mode = 'clear';
                }
            }

            initRain(count) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.w,
                        y: Math.random() * this.h,
                        l: Math.random() * 20 + 10, // length
                        v: Math.random() * 10 + 10, // velocity
                        a: Math.random() * 0.5 + 0.1 // alpha
                    });
                }
            }

            initStars(count) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.w,
                        y: Math.random() * this.h,
                        s: Math.random() * 2, // size
                        b: Math.random(),     // blink phase
                        v: Math.random() * 0.05 // movement
                    });
                }
            }

            loop() {
                this.ctx.clearRect(0, 0, this.w, this.h);

                if (this.mode === 'rain') {
                    this.ctx.strokeStyle = 'rgba(174, 194, 224, 0.5)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    for (let p of this.particles) {
                        this.ctx.moveTo(p.x, p.y);
                        this.ctx.lineTo(p.x, p.y + p.l);
                        p.y += p.v;
                        if (p.y > this.h) { p.y = -p.l; p.x = Math.random() * this.w; }
                    }
                    this.ctx.stroke();
                } 
                else if (this.mode === 'stars') {
                    this.ctx.fillStyle = 'white';
                    for (let p of this.particles) {
                        this.ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.001 + p.b) * 0.5;
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, p.s, 0, Math.PI * 2);
                        this.ctx.fill();
                        p.y -= p.v; // Drift up slightly
                        if (p.y < 0) p.y = this.h;
                    }
                }

                requestAnimationFrame(() => this.loop());
            }
        }

        // --- WEATHER STATION (LOGIC & API) ---
        class WeatherStation {
            constructor(visualCore) {
                this.visualCore = visualCore;
                this.init();
            }

            init() {
                // Try Geo first, then fallback
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => this.fetchData(pos.coords.latitude, pos.coords.longitude),
                        () => this.fetchData(CONFIG.location.lat, CONFIG.location.lon)
                    );
                } else {
                    this.fetchData(CONFIG.location.lat, CONFIG.location.lon);
                }
            }

            async fetchData(lat, lon) {
                document.getElementById('geo-loc').innerText = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
                
                const url = `${CONFIG.api.weather}?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,weathercode,uv_index,precipitation_probability&daily=sunrise,sunset&timezone=auto`;

                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    this.processData(data);
                } catch (e) {
                    console.error("Weather Error", e);
                    document.getElementById('weather-desc').innerText = "M·∫•t k·∫øt n·ªëi v·ªá tinh";
                }
            }

            processData(data) {
                const cur = data.current_weather;
                const hourIdx = new Date().getHours();
                const isDay = cur.is_day === 1;

                // 1. Display Basics
                document.getElementById('weather-temp').innerText = `${Math.round(cur.temperature)}¬∞`;
                document.getElementById('w-wind').innerText = cur.windspeed;
                document.getElementById('w-humid').innerText = data.hourly.relativehumidity_2m[hourIdx];

                // 2. Weather Code Parsing
                const wInfo = this.getCodeInfo(cur.weathercode);
                document.getElementById('weather-desc').innerText = wInfo.desc;
                document.getElementById('weather-icon-main').className = `fas ${wInfo.icon} weather-icon-lg`;
                
                // 3. Advanced UV Logic (Night = 0)
                let uv = data.hourly.uv_index[hourIdx];
                if (!isDay || hourIdx > 17 || hourIdx < 6) uv = 0;
                document.getElementById('w-uv').innerText = uv;

                // 4. Moon Phase Logic
                this.calcMoonPhase(new Date());

                // 5. Update Visuals (Canvas)
                this.visualCore.setMode(cur.weathercode, isDay);

                // 6. Generate Smart Alert
                this.generateAlert(data, uv, isDay, wInfo.desc);
            }

            getCodeInfo(code) {
                const map = {
                    0: {d: "Tr·ªùi quang ƒë√£ng", i: "fa-sun"},
                    1: {d: "C√≥ m√¢y nh·∫π", i: "fa-cloud-sun"},
                    2: {d: "Nhi·ªÅu m√¢y", i: "fa-cloud"},
                    3: {d: "√Çm u", i: "fa-smog"},
                    45: {d: "S∆∞∆°ng m√π", i: "fa-smog"},
                    51: {d: "M∆∞a ph√πn", i: "fa-cloud-rain"},
                    61: {d: "M∆∞a nh·∫π", i: "fa-cloud-showers-heavy"},
                    63: {d: "M∆∞a v·ª´a", i: "fa-cloud-showers-heavy"},
                    65: {d: "M∆∞a to", i: "fa-cloud-showers-heavy"},
                    80: {d: "M∆∞a r√†o", i: "fa-cloud-showers-water"},
                    95: {d: "D√¥ng l·ªëc", i: "fa-bolt"}
                };
                const info = map[code] || {d: "Kh√¥ng x√°c ƒë·ªãnh", i: "fa-cloud"};
                return { desc: info.d, icon: info.i };
            }

            calcMoonPhase(date) {
                // Algorithmic Moon Phase
                let year = date.getFullYear();
                let month = date.getMonth() + 1;
                let day = date.getDate();
                if (month < 3) { year--; month += 12; }
                let c = 365.25 * year;
                let e = 30.6 * month;
                let jd = c + e + day - 694039.09;
                jd /= 29.5305882;
                let b = parseInt(jd);
                jd -= b;
                let phase = Math.round(jd * 8);
                if (phase >= 8) phase = 0;

                const phases = [
                    {n: "New Moon", i: "fa-circle", t: "TrƒÉng M·ªõi"},
                    {n: "Waxing Crescent", i: "fa-moon", t: "L∆∞·ª°i Li·ªÅm"},
                    {n: "First Quarter", i: "fa-adjust", t: "B√°n Nguy·ªát"},
                    {n: "Waxing Gibbous", i: "fa-moon", t: "Khuy·∫øt Tr∆∞∆°ng"},
                    {n: "Full Moon", i: "fa-circle", t: "TrƒÉng Tr√≤n"}, // Use circle white via CSS
                    {n: "Waning Gibbous", i: "fa-moon", t: "Khuy·∫øt V·ªçng"},
                    {n: "Last Quarter", i: "fa-adjust", t: "B√°n Nguy·ªát"},
                    {n: "Waning Crescent", i: "fa-moon", t: "TrƒÉng T√†n"}
                ];
                
                const p = phases[phase];
                document.getElementById('moon-icon').className = `fas ${p.i}`;
                document.getElementById('moon-text').innerText = p.t;
                document.getElementById('moon-age').innerText = `${Math.floor(jd * 29.5)} days`;
            }

            generateAlert(data, uv, isDay, wDesc) {
                const hour = new Date().getHours();
                const nextRain = data.hourly.precipitation_probability.slice(hour, hour + 3).some(p => p > 50);
                
                let msg = "";
                let greeting = Utils.getGreeting();

                if (nextRain) {
                    msg = `B·∫£o Hy ∆°i, d·ª± b√°o <b>c√≥ m∆∞a</b> trong v√†i gi·ªù t·ªõi. N·∫øu ra ngo√†i em nh·ªõ mang √¥ nh√©! ‚òî`;
                } else if (uv >= 8 && isDay) {
                    msg = `Tr·ªùi n·∫Øng g·∫Øt l·∫Øm (UV: ${uv}). Em nh·ªõ <b>b√¥i kem ch·ªëng n·∫Øng</b> v√† m·∫∑c √°o kho√°c nha! ‚òÄÔ∏è`;
                } else if (hour >= 23 || hour < 4) {
                    msg = `Khuya r·ªìi, B·∫£o Hy ng·ªß s·ªõm ƒëi ƒë·ªÉ gi·ªØ g√¨n s·ª©c kh·ªèe nh√©. Ch√∫c em ng·ªß ngon! üåô`;
                } else {
                    msg = `${greeting} ${CONFIG.user}! Th·ªùi ti·∫øt ƒëang ${wDesc.toLowerCase()}. Ch√∫c em h·ªçc t·∫≠p hi·ªáu qu·∫£. ‚ù§Ô∏è`;
                }
                
                document.getElementById('alert-msg').innerHTML = msg;
            }
        }

        // --- NEWS ROOM (RSS) ---
        class NewsRoom {
            constructor() {
                this.fetchNews();
                setInterval(() => this.fetchNews(), CONFIG.refreshRate.news);
            }

            async fetchNews() {
                try {
                    const res = await fetch(CONFIG.api.rss);
                    const data = await res.json();
                    const items = data.items.slice(0, 15);
                    this.render(items);
                } catch (e) {
                    console.warn("RSS Fail");
                }
            }

            render(items) {
                const container = document.getElementById('news-feed');
                container.innerHTML = "";
                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'news-item';
                    div.style.animation = `slideIn 0.5s ease forwards ${index * 0.1}s`;
                    div.onclick = () => window.open(item.link, '_blank');
                    
                    const time = new Date(item.pubDate).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                    div.innerHTML = `
                        <span class="news-time">${time}</span>
                        <div class="news-title">${item.title}</div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // --- WIDGET MANAGER (POMO, TASKS) ---
        const Widgets = {
            Pomodoro: {
                timer: null,
                timeLeft: 1500,
                isRunning: false,
                toggle() {
                    const btn = document.getElementById('pomo-btn-main');
                    if (this.isRunning) {
                        clearInterval(this.timer);
                        this.isRunning = false;
                        btn.innerText = "Ti·∫øp t·ª•c";
                        btn.style.backgroundColor = "var(--color-accent)";
                    } else {
                        this.isRunning = true;
                        btn.innerText = "T·∫°m d·ª´ng";
                        btn.style.backgroundColor = "var(--color-warning)";
                        this.timer = setInterval(() => {
                            this.timeLeft--;
                            this.updateDisplay();
                            if (this.timeLeft <= 0) {
                                this.reset();
                                alert("Ho√†n th√†nh phi√™n l√†m vi·ªác! Ngh·ªâ ng∆°i th√¥i B·∫£o Hy ∆°i.");
                            }
                        }, 1000);
                    }
                },
                reset() {
                    clearInterval(this.timer);
                    this.isRunning = false;
                    this.timeLeft = 1500;
                    this.updateDisplay();
                    document.getElementById('pomo-btn-main').innerText = "B·∫Øt ƒë·∫ßu";
                },
                updateDisplay() {
                    const m = Math.floor(this.timeLeft / 60).toString().padStart(2, '0');
                    const s = (this.timeLeft % 60).toString().padStart(2, '0');
                    document.getElementById('pomo-timer').innerText = `${m}:${s}`;
                }
            },

            Tasks: {
                data: [],
                init() {
                    this.data = Utils.load('tasks') || [];
                    this.render();
                },
                add() {
                    const input = document.getElementById('task-in');
                    if (!input.value.trim()) return;
                    this.data.push({ text: input.value, done: false });
                    input.value = "";
                    this.save();
                    this.render();
                },
                toggle(index) {
                    this.data[index].done = !this.data[index].done;
                    this.save();
                    this.render();
                },
                delete(index) {
                    this.data.splice(index, 1);
                    this.save();
                    this.render();
                },
                save() {
                    Utils.save('tasks', this.data);
                },
                handleEnter(e) {
                    if (e.key === 'Enter') this.add();
                },
                render() {
                    const el = document.getElementById('task-list-ui');
                    el.innerHTML = "";
                    this.data.forEach((task, i) => {
                        const div = document.createElement('div');
                        div.className = `task-row ${task.done ? 'done' : ''}`;
                        div.innerHTML = `
                            <input type="checkbox" class="task-check" ${task.done ? 'checked' : ''} onchange="Widgets.Tasks.toggle(${i})">
                            <span style="flex:1; font-size: 0.9rem;">${task.text}</span>
                            <i class="fas fa-trash-alt" style="cursor:pointer; color:var(--color-danger); opacity:0.6;" onclick="Widgets.Tasks.delete(${i})"></i>
                        `;
                        el.appendChild(div);
                    });
                }
            },
            
            Calculator: {
                toggle() {
                    // Simple prompt based calc for lightweight UI
                    const res = prompt("Nh·∫≠p ph√©p t√≠nh (v√≠ d·ª•: 15*3):");
                    if (res) {
                        try {
                            alert(`K·∫øt qu·∫£: ${eval(res)}`);
                        } catch(e) { alert("L·ªói ph√©p t√≠nh"); }
                    }
                }
            }
        };

        // --- APP CONTROLLER ---
        const App = {
            init() {
                console.log("BaoHy OS Booting...");
                new TimeEngine();
                const visual = new VisualCore();
                const weather = new WeatherStation(visual);
                new NewsRoom();
                Widgets.Tasks.init();
                
                // Greeting Log
                console.log(`Welcome back, ${CONFIG.user}`);
            },
            
            toggleFullScreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            },

            reloadWeather() {
                location.reload();
            },

            openLink(url) {
                window.open(url, '_blank');
            }
        };

        // --- BOOT ---
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
